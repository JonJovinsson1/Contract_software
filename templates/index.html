<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contract Signature Tool</title>
    <style>
        body { font-family: sans-serif; background-color: #2b2b2b; color: #f0f0f0; margin: 0; padding: 20px; }
        .controls { padding-bottom: 20px; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .controls input, .controls button { padding: 8px; margin-right: 10px; }
        #image-container { border: 2px dashed #555; min-height: 500px; max-width: 900px; display: flex; align-items: center; justify-content: center; }
        #contract-image { max-width: 100%; max-height: 600px; cursor: crosshair; }
        #status { margin-top: 15px; font-style: italic; color: #999; }
    </style>
</head>
<body>
    <h1>Contract Signature Tool</h1>
    <div class="controls">
        <label>1. Load Contract (PNG): <input type="file" id="contract-input" accept="image/png"></label>
        <label>2. Load Signature (PNG): <input type="file" id="signature-input" accept="image/png"></label>
        <button id="save-btn" disabled>Save Final Contract</button>
    </div>

    <div id="image-container">
        <img id="contract-image" src="" alt="Load a contract to begin">
    </div>
    <div id="status">Ready.</div>

    <script>
        // Store image data as Base64 strings
        let contractB64 = null;
        let signatureB64 = null;
        let originalWidth = 0;
        let signatureWidth = 0;
        let signatureHeight = 0;
        let finalImageB64 = null;

        const contractInput = document.getElementById('contract-input');
        const signatureInput = document.getElementById('signature-input');
        const contractImage = document.getElementById('contract-image');
        const saveBtn = document.getElementById('save-btn');
        const statusDiv = document.getElementById('status');

        // Function to read a file and convert to Base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // Handle contract file selection
        contractInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            statusDiv.textContent = 'Loading contract...';
            contractB64 = await readFileAsBase64(file);
            contractImage.src = contractB64;

            // Get original dimensions for scaling later
            const img = new Image();
            img.onload = () => { originalWidth = img.width; };
            img.src = contractB64;
            statusDiv.textContent = 'Contract loaded. Now load a signature.';
        });

        // Handle signature file selection
        signatureInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            statusDiv.textContent = 'Loading signature...';
            signatureB64 = await readFileAsBase64(file);
            
            const img = new Image();
            img.onload = () => {
                signatureWidth = img.width;
                signatureHeight = img.height;
                statusDiv.textContent = 'Signature loaded. Click on the contract to place it.';
            };
            img.src = signatureB64;
        });

        // Handle clicking on the contract to place the signature
        contractImage.addEventListener('click', async (event) => {
            if (!contractB64 || !signatureB64) {
                statusDiv.textContent = 'Please load both a contract and a signature first.';
                return;
            }
            statusDiv.textContent = 'Processing... please wait.';
            
            // Calculate click coordinates relative to the original image size
            const rect = contractImage.getBoundingClientRect();
            const scaleX = contractImage.naturalWidth / rect.width;
            const scaleY = contractImage.naturalHeight / rect.height;
            const clickX = (event.clientX - rect.left) * scaleX;
            const clickY = (event.clientY - rect.top) * scaleY;

            // Send data to Python backend
            const response = await fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contract: contractB64, 
                    signature: signatureB64,
                    x: clickX,
                    y: clickY,
                    original_width: originalWidth,
                    signature_width: signatureWidth,
                    signature_height: signatureHeight
                })
            });

            const result = await response.json();
            if (result.status === 'success') {
                finalImageB64 = result.image;
                contractImage.src = finalImageB64; // Show the final image
                saveBtn.disabled = false;
                statusDiv.textContent = 'Ready to save!';
            } else {
                statusDiv.textContent = `Error: ${result.message}`;
            }
        });

        // Handle saving the final image
        saveBtn.addEventListener('click', () => {
            if (!finalImageB64) return;
            const link = document.createElement('a');
            link.href = finalImageB64;
            link.download = 'contract_signed.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            statusDiv.textContent = 'Image saved!';
        });

    </script>
</body>
</html>